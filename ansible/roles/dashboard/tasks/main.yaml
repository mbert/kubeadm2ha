#
# Sets up the dashboard
#
---

- name: Install Dashboard...
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl apply -f {{ DASHBOARD_INSTALL_URL }}" # noqa no-changed-when

- name: Install Metrics Server...
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl apply -f {{ METRICS_SERVER_INSTALL_URL }}" # noqa no-changed-when

- name: Work around kubelet self-signed certificate as generated by kubeadm...
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl patch deployment metrics-server -n kube-system --type 'json' -p '[{\"op\": \"add\", \"path\": \"/spec/template/spec/containers/0/args/-\", \"value\": \"--kubelet-insecure-tls\"}]'" # noqa no-changed-when

- name: Set kubernetes dashboard replicas
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl scale --replicas={{ groups['masters'] | length }} -n kubernetes-dashboard deployment/kubernetes-dashboard" # noqa no-changed-when

- name: Set metrics-scraper replicas
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl scale --replicas={{ groups['masters'] | length }} -n kubernetes-dashboard deployment/dashboard-metrics-scraper" # noqa no-changed-when

- name: Set metrics-server replicas
  ansible.builtin.shell: "export KUBECONFIG=/etc/kubernetes/admin.conf; kubectl scale --replicas={{ groups['masters'] | length }} -n kube-system deployment/metrics-server" # noqa no-changed-when
